{% extends "base.html" %} {% block content %}
<div class="dashboard-grid">
	<div class="main-col">
		<div class="glass-card">
			<h2 style="margin-top: 0">{{ _('dashboard_my_tasks') }}</h2>

			<div
				style="
					margin-bottom: 30px;
					padding-bottom: 20px;
					border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				"
			>
				<input
					type="text"
					id="newTaskTitle"
					placeholder="{{ _('dashboard_task_title_placeholder') }}"
					style="font-weight: bold"
				/>
				<div class="task-inputs-row">
					<input type="date" id="newTaskDate" />
					<div
						style="
							display: flex;
							align-items: center;
							background: rgba(0, 0, 0, 0.3);
							padding: 0 10px;
							border-radius: 8px;
							border: 1px solid rgba(255, 255, 255, 0.1);
							height: 46px;
							box-sizing: border-box;
						"
					>
						<input
							type="checkbox"
							id="isPublic"
							style="width: 20px; margin: 0; margin-right: 10px"
						/>
						<label for="isPublic" style="cursor: pointer; font-size: 0.9em"
							>{{ _('dashboard_public_label') }}</label
						>
					</div>
				</div>

				<div id="stepsContainer">
					<div class="new-step-row">
						<div
							class="custom-checkbox"
							onclick="toggleNewStepCheck(this)"
						></div>
						<input type="text" placeholder="{{ _('dashboard_step_placeholder') }} 1" />
					</div>
					<div class="new-step-row">
						<div
							class="custom-checkbox"
							onclick="toggleNewStepCheck(this)"
						></div>
						<input type="text" placeholder="{{ _('dashboard_step_placeholder') }} 2" />
					</div>
				</div>

				<button
					class="btn-primary"
					onclick="addNewStepInput()"
					style="
						background: transparent;
						border: 1px solid var(--accent-color);
						color: var(--accent-color);
						margin-bottom: 15px;
						width: 100%;
					"
				>
					{{ _('dashboard_add_step') }}
				</button>

				<button class="btn-primary" onclick="createTask()" style="width: 100%">
					{{ _('dashboard_create_task') }}
				</button>
			</div>

			<div id="taskList">{% include 'task_list.html' %}</div>
		</div>
	</div>

	<div class="widgets-col">
		<div class="glass-card">
			<h3 style="margin-top: 0">{{ _('dashboard_productivity') }}</h3>
			{% if graphJSON and graphJSON != 'null' %}
			<div id="chart" style="width: 100%; height: 230px"></div>
			<script>
				var graphs = {{ graphJSON | safe }};
				Plotly.newPlot('chart', graphs.data, graphs.layout, {displayModeBar: false});
			</script>
			{% else %}
			<div
				id="no-chart-placeholder"
				style="
					height: 150px;
					display: flex;
					align-items: center;
					justify-content: center;
					background: rgba(0, 0, 0, 0.2);
					border-radius: 12px;
					color: rgba(255, 255, 255, 0.4);
				"
			>
				{{ _('dashboard_no_stats') }}
			</div>
			<div id="chart" style="width: 100%; height: 230px; display: none"></div>
			{% endif %}
		</div>

		<div class="glass-card" id="weatherWidget">
			<div
				style="
					display: flex;
					justify-content: space-between;
					align-items: center;
					margin-bottom: 15px;
					gap: 10px;
				"
			>
				<h3 style="margin: 0; white-space: nowrap">{{ _('dashboard_weather') }}</h3>
				<div style="display: flex; gap: 5px; width: 100%; max-width: 180px">
					<input
						type="text"
						id="weatherCityInput"
						placeholder="{{ _('dashboard_weather_city_placeholder') }}"
						style="margin: 0; padding: 5px 8px; font-size: 0.85em; height: 30px"
					/>
					<button
						class="btn-primary"
						onclick="searchWeather()"
						style="
							padding: 0 10px;
							height: 30px;
							display: flex;
							align-items: center;
						"
					>
						üîé
					</button>
				</div>
			</div>
			<h4
				id="currentCityName"
				style="
					margin: -10px 0 15px;
					opacity: 0.7;
					font-weight: normal;
					font-size: 0.9em;
				"
			>
				{{ _('dashboard_weather_loading') }}
			</h4>
			<div id="weatherData">{{ _('dashboard_weather_loading') }}</div>
		</div>

		<div class="glass-card">
			<h3 style="margin-top: 0">{{ _('dashboard_currency') }}</h3>
			<div style="display: flex; gap: 10px">
				<input
					type="number"
					id="amount"
					value="100"
					oninput="convertCurrency()"
				/>
				<select id="currencyFrom" onchange="convertCurrency()">
					<option value="USD">USD</option>
					<option value="EUR">EUR</option>
					<option value="RUB">RUB</option>
					<option value="UZS">UZS</option>
					<option value="KZT">KZT</option>
					<option value="CNY">CNY</option>
				</select>
			</div>
			<div style="margin-bottom: 10px">
				{{ _('dashboard_currency_in') }}
				<select
					id="currencyTo"
					style="width: auto"
					onchange="convertCurrency()"
				>
					<option value="RUB" selected>RUB</option>
					<option value="UZS">UZS</option>
					<option value="USD">USD</option>
					<option value="EUR">EUR</option>
					<option value="KZT">KZT</option>
				</select>
			</div>
			<div
				id="conversionResult"
				style="font-size: 1.5em; font-weight: bold; color: var(--accent-color)"
			>
				---
			</div>
		</div>
	</div>
</div>

<script>
	const translations = {
		dashboard_weather_in_city: "{{ _('dashboard_weather_in_city') }}",
		dashboard_weather_forecast: "{{ _('dashboard_weather_forecast') }}",
		dashboard_weather_not_found: "{{ _('dashboard_weather_not_found') }}",
		dashboard_weather_no_connection: "{{ _('dashboard_weather_no_connection') }}",
		dashboard_step_placeholder: "{{ _('dashboard_step_placeholder') }}"
	};

	async function refreshTasks() {
		try {
			const response = await fetch("/dashboard/tasks_partial");
			if (response.ok) {
				const data = await response.json();
				document.getElementById("taskList").innerHTML = data.html;

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
				if (data.graphJSON && data.graphJSON !== "null") {
					var graphs = JSON.parse(data.graphJSON);
					const chartDiv = document.getElementById("chart");
					const placeholder = document.getElementById("no-chart-placeholder");

					if (placeholder) placeholder.style.display = "none";
					chartDiv.style.display = "block";

					Plotly.react("chart", graphs.data, graphs.layout, {
						displayModeBar: false,
					});
				}
			}
		} catch (e) {
			console.error("Failed to refresh tasks", e);
		}
	}

	function toggleNewStepCheck(el) {
		el.classList.toggle("checked");
	}

	function addNewStepInput() {
		const container = document.getElementById("stepsContainer");
		const div = document.createElement("div");
		const stepNum = container.querySelectorAll('.new-step-row').length + 1;
		div.className = "new-step-row";
		div.innerHTML = `
            <div class="custom-checkbox" onclick="toggleNewStepCheck(this)"></div>
            <input type="text" placeholder="${translations.dashboard_step_placeholder} ${stepNum}">
        `;
		container.appendChild(div);
	}

	async function createTask() {
		const title = document.getElementById("newTaskTitle").value;
		const date = document.getElementById("newTaskDate").value;
		const isPublic = document.getElementById("isPublic").checked;

		const stepRows = document.querySelectorAll(".new-step-row");
		const steps = [];

		stepRows.forEach((row) => {
			const text = row.querySelector('input[type="text"]').value;
			if (text.trim()) {
				steps.push({
					text: text,
					checked: row
						.querySelector(".custom-checkbox")
						.classList.contains("checked"),
				});
			}
		});

		if (!title) return;

		const response = await fetch("/api/add_task", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({
				title: title,
				deadline: date,
				steps: steps,
				is_public: isPublic,
			}),
		});

		if (response.ok) {
			document.getElementById("newTaskTitle").value = "";
			document
				.querySelectorAll(".new-step-row input")
				.forEach((i) => (i.value = ""));
			document
				.querySelectorAll(".new-step-row .custom-checkbox")
				.forEach((c) => c.classList.remove("checked"));
			await refreshTasks();
		}
	}

	async function toggleStep(id) {
		const response = await fetch(`/api/toggle_step/${id}`, { method: "POST" });
		if (response.ok) await refreshTasks();
	}

	async function toggleTask(id) {
		const response = await fetch(`/api/toggle_task/${id}`, { method: "POST" });
		if (response.ok) await refreshTasks();
	}

	async function toggleTaskPublic(id) {
		const response = await fetch(`/api/toggle_task_public/${id}`, {
			method: "POST",
		});
		if (response.ok) await refreshTasks();
	}

	// Weather
	async function loadWeather(city) {
		const widget = document.getElementById("weatherData");
		const cityNameEl = document.getElementById("currentCityName");
		widget.style.opacity = "0.5";

		try {
			const response = await fetch(`/api/get_weather?city=${city}`);
			const data = await response.json();

			if (data.cod == "200") {
				cityNameEl.innerText = `${translations.dashboard_weather_in_city} ${data.city.name}`;
				const current = data.list[0];
				const currentTemp = Math.round(current.main.temp);
				const currentDesc = current.weather[0].description;
				const currentIcon = current.weather[0].icon;

				let forecastHTML = `
                    <div style="display:flex; align-items:center; gap:15px; margin-bottom: 20px;">
                        <img src="https://openweathermap.org/img/wn/${currentIcon}@2x.png" style="width:70px;">
                        <div>
                            <div style="font-size:2.5em; font-weight:bold; line-height: 1;">${
															currentTemp > 0 ? "+" : ""
														}${currentTemp}¬∞</div>
                            <div style="text-transform: capitalize; opacity: 0.8; font-size: 0.9em;">${currentDesc}</div>
                        </div>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;">${translations.dashboard_weather_forecast}</div>
                `;

				const daily = {};
				data.list.forEach((item) => {
					const date = new Date(item.dt * 1000).toLocaleDateString("{{ current_lang }}-{{ current_lang.upper() }}", {
						weekday: "short",
						day: "numeric",
					});
					if (!daily[date] && Object.keys(daily).length < 4) {
						if (new Date(item.dt * 1000).getDate() !== new Date().getDate()) {
							daily[date] = item;
						}
					}
				});

				for (const [date, info] of Object.entries(daily)) {
					forecastHTML += `
                        <div class="forecast-item">
                            <span>${date}</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <img src="https://openweathermap.org/img/wn/${
																	info.weather[0].icon
																}.png" style="width:30px; height:30px;">
                                <span>${
																	Math.round(info.main.temp) > 0 ? "+" : ""
																}${Math.round(info.main.temp)}¬∞</span>
                            </div>
                        </div>
                    `;
				}
				widget.innerHTML = forecastHTML;
			} else {
				widget.innerHTML = translations.dashboard_weather_not_found;
				cityNameEl.innerText = translations.dashboard_weather_not_found;
			}
		} catch (e) {
			widget.innerHTML = translations.dashboard_weather_no_connection;
		}
		widget.style.opacity = "1";
	}

	function searchWeather() {
		const input = document.getElementById("weatherCityInput");
		const city = input.value.trim();
		if (city) {
			localStorage.setItem("weather_city", city);
			loadWeather(city);
			input.value = "";
		}
	}

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≥–æ–¥—ã
	const savedCity = localStorage.getItem("weather_city") || "Moscow";
	loadWeather(savedCity);

	// Currency
	async function convertCurrency() {
		const amount = document.getElementById("amount").value;
		const from = document.getElementById("currencyFrom").value;
		const to = document.getElementById("currencyTo").value;
		const resDiv = document.getElementById("conversionResult");

		if (!amount) return;

		resDiv.style.opacity = "0.5";
		try {
			const response = await fetch(`/api/get_currency?from=${from}&to=${to}`);
			const data = await response.json();

			if (data && data.rate) {
				resDiv.innerText = `${(amount * data.rate).toFixed(2)} ${to}`;
			} else {
				resDiv.innerText = "Error";
			}
		} catch (e) {
			resDiv.innerText = "Error";
		}
		resDiv.style.opacity = "1";
	}
	convertCurrency();
</script>
{% endblock %}